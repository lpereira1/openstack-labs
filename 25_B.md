---
date: "2016-10-09"
draft: false
weight: 255
title: "Lab 25_B - Neutron Networking at the CLI"
---

## Lab 25_B - Neutron Networking at the CLI - &#x2B50;REQUIRED&#x2B50;

### WEDNESDAY

### Lab Objective

The objective of this lab is to use the Neutron service at the CLI. In this section, we'll create almost the same network as we created for acme_inc, only for a different tenant (vault_tek). This way you can compare and contrast the differences between working with the OpenStack Horizion dashboard and the CLI commands. At the conclusion of this lab, students should feel comfortable creating and modifying network settings using the python-openstackclient and python-neutronclient. It is worth noting, that some network commands still depend on using the python-neturonclient.

### Procedure

0. We don't need any old terminal windows open, so close them all, and then open a new one. Once you have a new terminal window open, SSH to controller. 

    `student@beachhead:/$` `ssh controller`

0. The CLI prompt should now read as follows:

    `student@controller:~$`

0. Source the chester.rc permissions file

    `student@controller :~$` `source chester.rc`
    
0. Create a vault-tek-network in the vault_tek project.

    `student@controller (chester) :~$` `openstack network create vault-tek-network`
    >
    If sucessful, details of the network will be shown.

0. Now create a vault-tek-network subnet

    `student@controller (chester) :~$` `neutron subnet-create --name vault-tek-network-subnet-10 --gateway 10.10.0.1 vault-tek-network 10.10.0.0/24`
	>
	NOTE: The command listed above line wraps, so be sure to include the second line as well, or an error stating "too few arguments" will occur.

    ```
Created a new subnet:
+-------------------+----------------------------------------------+
| Field             | Value                                        |
+-------------------+----------------------------------------------+
| allocation_pools  | {"start": "10.10.0.2", "end": "10.10.0.254"} |
| cidr              | 10.10.0.0/24                                 |
| created_at        | 2016-10-14T05:17:18                          |
| description       |                                              |
| dns_nameservers   |                                              |
| enable_dhcp       | True                                         |
| gateway_ip        | 10.10.0.1                                    |
| host_routes       |                                              |
| id                | 7f8386fd-36e4-43e3-af78-334bddda3326         |
| ip_version        | 4                                            |
| ipv6_address_mode |                                              |
| ipv6_ra_mode      |                                              |
| name              | vault-tek-network-subnet-10                  |
| network_id        | c3eb9915-b84c-446e-b021-18d108e139e4         |
| subnetpool_id     |                                              |
| tenant_id         | d8be1baa8a8b4b26af4d140cfcca9586             |
| updated_at        | 2016-10-14T05:17:18                          |
+-------------------+----------------------------------------------+
    ```

0. Create a vault-tek-network router 

    `student@controller (chester) :~$` `neutron router-create vault-tek-router`

    ```
Created a new router:
+-------------------------+--------------------------------------+
| Field                   | Value                                |
+-------------------------+--------------------------------------+
| admin_state_up          | True                                 |
| availability_zone_hints |                                      |
| availability_zones      |                                      |
| description             |                                      |
| external_gateway_info   |                                      |
| id                      | e260a2d4-428b-43b2-a575-b467dc8e68e8 | <- This is the <ROUTER_ID> you'll need below!
| name                    | vault-tek-router                     |
| routes                  |                                      |
| status                  | ACTIVE                               |
| tenant_id               | d8be1baa8a8b4b26af4d140cfcca9586     |
+-------------------------+--------------------------------------+

    ```
    
0. List the available networks.

0. Connect vault-tek-router to the provider-net network. 
    
    `student@controller (chester) :~$` `neutron net-list`
    ```
    +--------------------------------------+--------------------+----------------------------------------------------+
    | id                                   | name               | subnets                                            |
    +--------------------------------------+--------------------+----------------------------------------------------+
    | c3eb9915-b84c-446e-b021-18d108e139e4 | vault-tek-network  | 7f8386fd-36e4-43e3-af78-334bddda3326 10.10.0.0/24  |
    | b3b8d8f8-6668-48dc-b97e-db92be7c6fc7 | provider-net       | 571e4cd2-1b9d-4b05-9ee9-f23bc27451ae 172.16.2.0/24 |
    +--------------------------------------+--------------------+----------------------------------------------------+
    ```
    
    `student@controller (chester) :~$` `neutron router-gateway-set vault-tek-router <UUID_OF_PROVIDER_NET>`
    >
    Set gateway for router vault-tek-router

0. Show the router using less with horizontal scrolling

    `student@controller (chester) :~$` `neutron router-show <ROUTER-ID> | less -S`

0. Connect the vault-tek-router to vault-tek-network-subnet-10

    `student@controller (chester) :~$` `neutron router-interface-add vault-tek-router vault-tek-network-subnet-10`

0. Check out the router now:

    `student@controller (chester) :~$` `neutron router-show <ROUTER-ID>  | less -S`

0. Okay, I don't see the new interface, try this!

    `student@controller (chester) :~$` `neutron router-port-list <ROUTER-ID>`


    ```
    +--------------------------------------+------+-------------------+----------------------------------------------------------------------------------+
    | id                                   | name | mac_address       | fixed_ips                                                                        |
    +--------------------------------------+------+-------------------+----------------------------------------------------------------------------------+
    | 07a17c22-478a-40d8-a01b-38cc78d29333 |      | fa:16:3e:9a:83:b6 | {"subnet_id": "36ac8b4a-296f-4992-8248-dfccf2125da0", "ip_address": "10.10.0.1"} |
    +--------------------------------------+------+-------------------+----------------------------------------------------------------------------------+
    ```

0. Log into the OpenStack Horizon dashboard as **:default:chestercopperpot:fa5tpa55w0rd:**

0. Navigate to **Project > Network > Network Topology**

    ![Network Topology Vault Tek](https://alta3.com/labs/images/alta3_lab_horizon_network_topo_chester.png)

0. Navigate to **Project > Network > Networks**

    ![Network Not Shared](https://alta3.com/labs/images/alta3_lab_big_red_arrow.png)

    > Note that this network is not a shared network (see the big red arrow on the above screenshot), therefore it cannot be seen by other projects (tenants). Let's confirm this. 

0. Log out of the OpenStack Horizon dashboard, log back in as **:default:aliceanderson:fa5tpa55w0rd:**

0. As aliceanderson, navigate to **Project > Network > Networks**. You should no longer see vault-tek-network. This confirms that the network is indeed private.

0. Log back into the OpenStack Horizon dashboard as **:default:chestercopperpot:fa5tpa55w0rd:**

0. Navigate to **Project > Network > Routers**

0. Click on the router instance **vault-tek-router**. See the screenshot below if you are lost.

    ![Router Click](https://alta3.com/labs/images/alta3_lab_horizon_vt_router_click.png)

0. IMPORTANT: On the screen you are currently on, look for a value called "ID" which is highlighted yellow in the figure above. It is second down on the overview tab. Write down the first 6 or so characters. These will be helpful later.	



15. Review the rest of the information being presented. Note that the router is connected to a Gateway (public). Now explore the **Overview** and **Interfaces** tabs. Within the **Interfaces** tab, you will find a list of associated interfaces connected to the router. The screenshot below is what is displayed after clicking on the **Interfaces** tab. Note that this router has a fixed IP address (10.10.0.1), which connects it to the 10.10.0.0/24 network we just created.

	![](https://i.imgur.com/qRIpRMl.png)

	* You are looking at the interface on the vault-tek-router

16. List the subnetworks you created this week.

    `[root@controller] ~(keystone_chestercopperpot)#`  `source keystonerc_admin`

    `[root@controller ~(keystone_admin)]#`  `neutron subnet-list`

    ```
    +--------------------------------------+-----------------------------+-----------------+--------------------------------------------------+
    | id                                   | name                        | cidr            | allocation_pools                                 |
    +--------------------------------------+-----------------------------+-----------------+--------------------------------------------------+
    | a71c27e2-a79e-4c2e-9ee5-06261376fb42 | acme-inc-network-subnet-10  | 10.10.0.0/24    | {"start": "10.10.0.2", "end": "10.10.0.254"}     |
    | 36ac8b4a-296f-4992-8248-dfccf2125da0 | vault-tek-network-subnet-10 | 10.10.0.0/24    | {"start": "10.10.0.2", "end": "10.10.0.254"}     |
    | ba02f29e-de66-4f21-84c4-777ce7e863c4 | public_subnet               | 172.24.4.224/28 | {"start": "172.24.4.226", "end": "172.24.4.238"} |
    | 86e6e695-7775-46ef-827f-64c4306bb69f | private_subnet              | 10.0.0.0/24     | {"start": "10.0.0.2", "end": "10.0.0.254"}       |
    +--------------------------------------+-----------------------------+-----------------+--------------------------------------------------+
    ```

    `[root@controller ~(keystone_admin)]#`  `neutron subnet-show vault-tek-network-subnet-10`

    ```
    +-------------------+----------------------------------------------+
    | Field             | Value                                        |
    +-------------------+----------------------------------------------+
    | allocation_pools  | {"start": "10.10.0.2", "end": "10.10.0.254"} |
    | cidr              | 10.10.0.0/24                                 |
    | dns_nameservers   |                                              |
    | enable_dhcp       | True                                         |
    | gateway_ip        | 10.10.0.1                                    |
    | host_routes       |                                              |
    | id                | 36ac8b4a-296f-4992-8248-dfccf2125da0         |
    | ip_version        | 4                                            |
    | ipv6_address_mode |                                              |
    | ipv6_ra_mode      |                                              |
    | name              | vault-tek-network-subnet-10                  |
    | network_id        | 854e1cb3-9234-43ce-b467-47d5bfdf3539         |
    | subnetpool_id     |                                              |
    | tenant_id         | f2b7cc476b904fe0adb5855281038598             |
    +-------------------+----------------------------------------------+
    ```


#### 3. Launch an instance, and SSH into it (this is **WAY COOL!**)
 	
Now that we know a bit about security groups and networks, let's launch a new instance, and see if we can SSH into it! 

2. Navigate to **Project > Compute > Instances**

3. Click on the "Launch Instance" button

    ![Network Topology Vault Tek](https://alta3.com/labs/images/alta3_lab_horizon_network_topo_chester.png)
4. Fill out the **Details** tab as follows:

    ![](https://i.imgur.com/JM7H0BL.png)

5. Now click on the **Access & Security** tab so we can add our security group

    * Check the box **http-ssh**
    * Uncheck the box **default**

    ![](https://i.imgur.com/Po7DpST.png)


 
6. Now click on the **Networking** tab and click the **+** sign beside the **vault-tek-network**.  Shown below are the before and after screen shots.

    **BEFORE**
    ![](https://i.imgur.com/PQJ56xQ.png)

    **Install only the vault-tek-networking**
    ![](https://i.imgur.com/bjOwNN3.png)


7. Great! Now click the "Launch" button and you will notice the instance "Spawning", then "Running". See the screen shots below 
 
    **vt2 is Spawning**
    ![](https://i.imgur.com/2jQ6w4r.png)


    **vt2 is Running**
    ![](https://i.imgur.com/Eh84NmZ.png)


 * Wait until the machine spawns and comes up as **ACTIVE** and **Running** before going to the next step
 
8. Before we SSH to the Neutron server, type the following command to check out your new instance:

    `source keystonerc_chestercopperpot`  (In case you may still be sourced as keystonerc_admin)

    `[root@controller] ~(keystone_chestercopperpot)#` `nova show vt2`
	
	```
	+--------------------------------------+----------------------------------------------------------+ 
	| Property                             | Value                                                    |  
	+--------------------------------------+----------------------------------------------------------+   
	| OS-DCF:diskConfig                    | AUTO                                                     | 
	| OS-EXT-AZ:availability_zone          | nova                                                     |   
	| OS-EXT-STS:power_state               | 1                                                        |
	| OS-EXT-STS:task_state                | -                                                        |
	| OS-EXT-STS:vm_state                  | active                                                   |
	| OS-SRV-USG:launched_at               | 2015-10-28T20:43:59.000000                               |
	| OS-SRV-USG:terminated_at             | -                                                        | 
	| accessIPv4                           |                                                          |
	| accessIPv6                           |                                                          |
	| config_drive                         |                                                          |
	| created                              | 2015-10-28T20:42:53Z                                     |
	| flavor                               | m1.tiny (1)                                              |
	| hostId                               | 1f9d27fe57644512f82655d7339f19ae4c86a026c80f4db3a786ed39 |
	| id                                   | 53ad58a5-4fae-45f7-a03b-d82a64e3452f                     |
	| image                                | cirros (8a724f78-2673-4ea1-b607-373626a15afb)            |
	| key_name                             | -                                                        |
	| metadata                             | {}                                                       |
	| name                                 | vt2                                                      |
	| os-extended-volumes:volumes_attached | []                                                       |
	| progress                             | 0                                                        |
	| security_groups                      | http-ssh                                                 |
	| status                               | ACTIVE                                                   |
	| tenant_id                            | 41773a923b924ef7934e8aea532c0680                         |
	| updated                              | 2015-10-28T20:43:59Z                                     |
	| user_id                              | 7198d60229d14888914d6e1ef5d0ef2b                         |
	| vault-tek-network network            | 10.10.0.3                                                |
	+--------------------------------------+----------------------------------------------------------+  
	```
	
	* Look at the VERY bottom of the output. It should say, "vault-tek-network network" followed by an IP address. It is likely something like 10.0.0.2, 10.0.0.3, 10.10.0.2, or 10.10.0.3. It doesn't matter what it is, just record it. We'll need it to SSH to this VM instance (vt2)
 
8. Navigate back to the CLI, time to SSH into the machine. In order to do this, we'll need to access that machine's namespace. In order to do this, we'll SSH to the neutron server. Type the following:

    `[root@controller] ~(keystone_chestercopperpot)#` `ssh root@neutron`
 
    `[root@neutron ~]#`
 
9. Fantastic. We are now in a Neutron node. If you're confused, click back to Lab 00, and check out the picture of the network. Remember that this is a dedicated node just for Neutron. Networking takes resources! Let's take a look at the namespaces the neutron node knows about. Type the following command:

    `[root@neutron ~]#` `ip netns list`
 
    ```
	qrouter-b1579da2-d5a4-40ec-b6a5-606413f1738e
	qdhcp-cfe3722a-f584-4150-a6ae-1a178677ac78
	qrouter-c9a2b225-bab6-4965-9c98-417d9a53ba3c
	qdhcp-3288dfae-a262-42c2-92b2-1b6ae652fa5b
	qdhcp-20ca30a2-e3fb-4e62-bd78-08dc471e93ed
	```
 
 * The above command is going to create some output. Look near the top of the output. We're looking for a match that begins **qrouter-**, but notice that there are many **qrouter-** entries. We want the one that is followed by the same characters you recorded back in step "2.13"

 * Once you've found this value, copy it to the clipboard with your mouse
 
10. Now we're going to tell Ubuntu to allow us access to access that router's namespace. After we're in the namespace, we'll have SSH access to the VM we just created. If it works, you'll be prompted to log into the VM instance you just created (vt2). Keep reading through this step for the username / password of the cirros machine.

	`[root@neutron ~]#` `ip netns exec <<NAMESPACE>> ssh cirros@<<IP_ADDRESS_of_vt2>>`
	
	
	> EXAMPLE ONLY: ip netns exec qrouter-b1579da2-d5a4-40ec-b6a5-606413f1738e ssh cirros@10.10.0.3
	  - **NOTE 1:** The name space should include qrouter- portion in front of the ID
	  - **NOTE 2:** The IP_address_of_vt2 was obtained in step 7 when you issued the command "nova show vt2" on the controller.
	  - **NOTE 3:** The username and password for all cirros machines is **cirros** and **cubswin:)** by default. Don't forget the smiley!
	
	```
	The authenticity of host '10.10.0.3 (10.10.0.3)' can't be established.
	RSA key fingerprint is 26:6b:23:9c:ab:bb:eb:b5:3a:18:b5:8e:72:ba:b4:4f.
	Are you sure you want to continue connecting (yes/no)? yes					<- Type YES then enter
	Warning: Permanently added '10.10.0.3' (RSA) to the list of known hosts.
	cirros@10.10.0.3's password: cubswin:)										<- The password to all cirros images is cubswin:)
	```

11. There you go! If it worked, you'll be inside of the little VM you just started! This lab was heavy lifting, so if you don't understand something, ask the instructor.

12. There isn't much to see inside of a CirrOS VM, so once your curiosity is satisfied, type the following to return to root@controller

    `$` `exit`
	
    `[root@neutron ~]#` `exit`
	
13. Run the **nova list** command and shut off vt2, as well as any other VMs that are started and running.

    `[root@controller ~(keystone_chestercopperpot)]# nova list`
    
    `[root@controller ~(keystone_chestercopperpot)]# nova stop vt2`

14. Repeat the above step until all VMs are shutdown. Finally, type the following to start a new bash shell and return to root@controller.

    `[root@controller ~(keystone_chestercopperpot)]#`  `source .bashrc`

    `[root@controller ~]#`

     > This will put you back to root. Done!
