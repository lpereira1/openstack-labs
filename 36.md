---
date: "2017-02-22"
draft: false
weight: 360
title: "Lab 36 - Containers"
---
[Click here to find out more about Alta3 Research's Openstack Training](https://alta3.com/courses/openstack)

### THURSDAY - &#x2B50;REQUIRED&#x2B50;

### Lab Objective

### Procedure


# Creating LXC containers for OpenStack
![alt text](https://alta3.com/images/openstack_network_diagram.png "OpenStack networking using containers")
### Bonded Interfaces
This design requires only two physical NICs, bonded together using IEEE 802.1ad aggregation. This bonding mode, also called "bond-mode 4", sets up the bonded interfaces in "active-active" mode, so both interfaces when bonded, appear as a single bond0 interface. Unplug one of the bonded interfaces, all traffic shifts to the interface still standing in 100 ms. When both interfaces are up, traffic passing through the bonded interface balances across both interfaces, so "aggregate-throughput" will be twice the speed of a single interface, but there is a caveat here. No individual session can exceed the speed of a single link (eth0 or eth1). This reason for this is that the bond0 interface hashes the source and destination mac (or mac + ipaddr) and then uses modulo math to determine which link the packet will traverse. By definition, a single flow will always use the same source and dest addresses, so will always generate the same hash, therefore, ALWAYS be mapped to just one of the two interfaces. But when looking at aggregate traffic, both links team together and traffic will balance given random source and destination addresses.  
### Linux Containers
This design also adds clean isolation of the openstack components. Components that make sense to be in the same container, are placed in the same container. Using this teachnique, small clouds may place all comonents on a single controller node, or spread them accross several nodes if necessary. The ansible based automation that installs the software can install a container on any node, and the nework design uses VLAN isolation to allow secure communications between two or more nodes. The bonded interface, also will allow networking to continue to work in the case of a defective network connection.

1. Install dependencies  
    `sudo apt-get install lxc lxc-templates wget bridge-utils`
    > There are two files that are referenced when creating an lxc. These two files will be referenced when you create your container. The new container no longer references those two files and instead uses a new file: **`/var/lib/lxc/<container>/config`** which will exist after the container is created. 
    Let's edit them to suit our needs: 
    `/etc/lxc/default.conf`
    `/etc/default/lxc-net` 
 
2. Edit the lxc-net file  
   `sudo vim /etc/default/lxc-net`  
   
    ```
    # /etc/lxc/default.conf
    USE_LXC_BRIDGE="false"
    LXC_BRIDGE="br-mgnt"
    ```

0. Edit the default.conf file:  
   `sudo vim /etc/lxc/default.conf`  
   
    ```
    lxc.network.type = veth
    lxc.network.link = br-mgnt
    lxc.network.flags = up
    # MTU set just in case we are behind a VXLAN interface
    lxc.network.mtu = 1450
    lxc.network.ipv4 = 10.16.0.90/24 10.16.0.255
    # lxc.network.ipv4 = {{ ansible_var }}/{maintenance_cidr }} {{mainteance_broadcast_addr }}
    lxc.network.ipv4.gateway = 10.16.0.1
    lxc.network.hwaddr = 02:16:3e:xx:xx:xx
    ```
    > **Locally administered MACs:** mac addresses that are safe for virtual interfaces have a binary prefix of xxxxxx10, so these MAC address (in hex) are safe to use. If randomly chosen, the changes of a collision are very high: 
x2-xx-xx-xx-xx-xx
x6-xx-xx-xx-xx-xx
xA-xx-xx-xx-xx-xx
xE-xx-xx-xx-xx-xx
0. Edit the /etc/network/interfaces file
    `sudo vim /etc/network/interfaces`
    ``` 
    auto lo
        iface lo inet loopback
    
    auto bond0
        iface bond0 inet manual
        bond-mode 4
        bond-slaves none
        bond-miimon 100
        bond-lacp-rate 1
        up ip link set dev $IFACE up
        down ip link set dev $IFACE down
    
    auto enp3s0f1
        iface enp3s0f1 inet manual
        bond-master bond0
    
    auto enp4s0f0
        iface enp4s0f0 inet manual
        bond-master bond0
    
    # Management VLAN which will connect to br-mgnt
    auto  bond0.1600
        iface bond0.1600 inet manual
        up ip link set dev $IFACE up
        down ip link set dev $IFACE down
    #Provider LAN which will connect to ovs br-ex
    auto  bond0.1200
        iface bond0.1200 inet static
        address 10.3.100.100
        netmask 255.240.0.0
        
    # LXC bridge for Openstack management containers
    auto br-mgnt
        iface br-mgnt inet static
        # Important! Connect bridge to the management interface
        bridge_ports auto  bond0.1600
        bridge_stp off
        bridge_fd 9
        address 10.16.0.100
        netmask 255.255.255.0
        network 10.16.0.0
        broadcast 10.16.0.255
        gateway 10.16.0.1
        dns-nameservers 10.0.16.1
    ```
0. Restart networking
  `sudo service networking restart`
0. Launch the first lxc, this example for keystone
   `sudo lxc-create  -n keystone_lxc  -t ubuntu  --rc=/etc/default/lxc-net`  
   
    > -n = name of container  
    -t = template name  
    -s = overrides any value specified in the config file  
0. start the newly created container  
   `sudo lxc-start -n keystone_lxc -d` 
   
    > -n = name of container  
    -d = run container as a demon (no arguments needed)  
0. console into the container  
  `sudo lxc-console -n keystone_lxc`  
  
    >  login: ubuntu  
    password: ubuntu
